<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connexion Popup</title>
  <link rel="stylesheet" href="main.css" />
</head>
<body>
  
  <div class="Barre_task" >
    <button class="buton_se_connecter" id="buton_se_connecter" onclick="open_popup_se_connecter()">Se connecter</button>
    <button class="Home_button" onclick="open_div_Home()">Home</button>
    <button class="buton_Moyen" onclick="open_popup_Moyen()">Moyen</button>
    <button class="buton_question" onclick="open_popup_question()">Question</button>
    <p class="buton_se_connecter" id="text_place_button_se_connecter" style="display:none;"></p>
  </div>

  <!-- Overlay pour fond sombre -->
  <div id="overlay"></div>

  <!-- Fenêtre popup connexion -->
  <div class="popup_se_connecter" id="popup_se_connecter" style="display:none;">
    <p class="decors1">__</p>
    <h2 class="h2_connexion">Connexion</h2>
    <p class="Inserez_votre_identifiants">Insérez votre identifiant</p>
    <input type="text" class="input_id" id="input_id" />
    <p class="Inserez_votre_mp">Insérez votre mot de passe</p>
    <input type="password" class="input_mp" id="input_mp" />
    <button class="create_account" type="button" onclick="open_popup_create_compte()">Créer</button>
    <button class="popup_se_connecter_button" onclick="sendName_connexion()">Suivant</button>
  </div>

  <!-- Popup création de compte -->
  <div class="popup_create_compte" id="popup_create_compte" style="display:none;">
    <button class="popup_create_compte_button" onclick="sendName_create()">Créer</button>
    <button class="ruturn_create_account" onclick="open_popup_se_connecter()">Retour</button>
    <h2 class="h2_create_account">Créer un compte</h2>
    <p class="inserez_id_create_account">Insérez un identifiant</p>
    <p class="inserez_mp_create_account">Insérez un mot de passe</p>
    <p class="confirm_mp_create_account">Confirmez le mot de passe</p>
    <input class="input_id_account" id="input_id_account" />
    <input type="password" class="input_mp_create_account" id="input_mp_create_account" />
    <input type="password" class="input_confirm_mp_create_account" id="input_confirm_mp_create_account"/>
    <p class="decors2">__</p>
  </div>

  <!-- Home -->
  <div class="Home" id="Home" style="display:block;">
    <h1 id="Welcome" class="Welcome">Welcome <span id="Welcome_nom"></span></h1>
    <div id="Home_div_left"><p></p></div>
  </div>
  <div class="Question" id="Question" style="display:none;">
  </div>

  <div class="popup_Moyen" id="popup_Moyen" style="display:none;">
    <div class="ajouter_notes" id="ajouter_notes">
      <label class="Lnote" for="note">Ta note</label>
      <label class="Lsur" for="sur">Sur combien</label>
      <label class="Lcoef" for="coef">Le coef</label>
      <input id="INnote" class="note">
      <input id="INsur" class="sur">
      <input id="INcoef" class="coef">
      <label class="Math" for="matiere">Choisis une matière :</label>
      <select class="Math" id="matiere" name="matiere">
        <option class="math" value="Mathématiques">Mathématiques</option>
        <option class="phisique" value="Physique">Physique</option>
        <option class="svt" value="SVT">SVT</option>
        <option class="fr" value="Français">Français</option>      
        <option class="histoire" value="Histoire">Histoire</option>
        <option class="angl" value="Anglais">Anglais</option>
        <option class="esp" value="Espagnole">Espagnole</option>
        <option class="sport" value="Sport">Sport</option>
        <option class="tech" value="Technologie">Technologie</option>
        <option class="musique" value="Musique">Musique</option>
        <option class="arts" value="Arts-plastique">Arts-plastique</option>
        <option class="latin" value="Latin">Latin</option>
        <option class="chor" value="Chorale">Chorale</option>
      </select>
      <button onclick="sendnote()">Enregistrer la note</button>
    </div>
  </div>

  <div id="popup_result"class="popup_result" style="display:none;"> <!-- Affichage caché par défaut -->
    <p id="result_message" class="result_message"></p> <!-- Attention, ne pas avoir deux éléments avec cet ID -->
    <button id="bFermeP1" class="bFermeP1" onclick="close_popup_result()">x</button>
  </div>

<script>
  // Variable nom
  let nom = "Invité"; // pas var, pas const
document.getElementById('Welcome_nom').textContent = nom;


  // Fonctions popup et affichages
  function open_popup_question() {
    closeAllPopups();
    close_div_Home();
    document.getElementById('Home').style.display = 'none';
    document.getElementById('Question').style.display = 'block';
  }
  function close_popup_question() {
    document.getElementById('Question').style.display = 'none';
  }
  function open_popup_Moyen() {
    closeAllPopups();
    document.getElementById('Home').style.display = 'none';
    document.getElementById('popup_Moyen').style.display = 'block';
  }
  function close_popup_Moyen() {
    document.getElementById('popup_Moyen').style.display = 'none';
  }
  function open_popup_se_connecter() {
    closeAllPopups();
    document.getElementById('Home').style.display = 'block';
    document.getElementById('popup_create_compte').style.display = 'none';
    document.getElementById('popup_se_connecter').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
  }
  function close_popup_se_connecter() {
    document.getElementById('popup_se_connecter').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  }
  function open_popup_result(){
  const popup = document.getElementById('popup_result');
  slideInUp(popup)
  popup.style.display = 'flex';
  popup.style.zIndex = '99999';
  popup.style.position = 'fixed';
  popup.style.bottom = '0%';
  popup.style.right = '0%',
  popup.style.background = 'white';
  popup.style.padding = '30px';
  popup.style.border = '2px solid black';
  popup.style.fontFamily = 'arial';
}


  function close_popup_result() {
    document.getElementById('popup_result').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  }
  function open_popup_create_compte() {
  closeAllPopups();
  document.getElementById('Home').style.display = 'flex';
  document.getElementById('popup_create_compte').style.display = 'block';
  document.getElementById('popup_se_connecter').style.display = 'none'; // flex pour respecter css
  document.getElementById('overlay').style.display = 'block';
}

  function close_popup_create_compte() {
    document.getElementById('popup_create_compte').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  }
  function open_div_Home() {
    closeAllPopups();
    document.getElementById('popup_se_connecter').style.display = 'none';
    document.getElementById('popup_create_compte').style.display = 'none';
    document.getElementById('Home').style.display = 'block';
    document.getElementById('overlay').style.display = 'none';
  }
  function close_div_Home() {
    document.getElementById('Home').style.display = 'none';
  }
  function closeAllPopups() {
    close_popup_se_connecter();
    close_popup_create_compte();
    close_popup_Moyen();
    close_popup_question();
  }
  async function sendnote() {
  const id = nom; // Doit être défini après connexion
  const matiere = document.getElementById('matiere').value.trim();
  const noteStr = document.getElementById('note').value.trim();
  const surStr = document.getElementById('sur').value.trim();
  const coefStr = document.getElementById('coef').value.trim();
  const autre = "";

  // Vérifier que l'utilisateur est connecté
  if (!id || id === "Invité") {
    document.getElementById('result_message').innerText = 'Connecte-toi avant d’ajouter une note.';
    open_popup_result();
    return;
  }

  const note = parseFloat(noteStr.replace(',', '.'));
  const sur = parseFloat(surStr.replace(',', '.'));
  const coef = parseFloat(coefStr.replace(',', '.'));

  if (!matiere || isNaN(note) || isNaN(sur) || isNaN(coef)) {
    document.getElementById('result_message').innerText = 'Tous les champs doivent être remplis avec des nombres valides.';
    open_popup_result();
    return;
  }

  try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 0,
        id,
        matiere,
        note,
        sur,
        coef,
        autre
      })
    });

    const data = await response.json();

    document.getElementById('result_message').innerText = data.message || 'Note enregistrée !';
    open_popup_result();

    // Vider les champs
    document.getElementById('note').value = '';
    document.getElementById('sur').value = '';
    document.getElementById('coef').value = '';
  } catch (error) {
    document.getElementById('result_message').innerText = 'Erreur lors de l\'envoi de la note : ' + error.message;
    open_popup_result();
  }
}


  async function sendName_connexion() {
  close_popup_se_connecter();
  close_popup_create_compte();

  const name = document.getElementById('input_id').value.trim();
  const mp = document.getElementById('input_mp').value.trim();
  const action = 0;

  if (!name || !mp) {
    const resultMessage = document.getElementById('result_message');
    resultMessage.innerText = 'Veuillez remplir tous les champs.';
    open_popup_result();
    return;
  }

  try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/greet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, mp, action })
    });

    const data = await response.json();

    document.getElementById('result_message').innerText = data.message;
    nom = name; // <--- met à jour la variable globale
    document.getElementById('Welcome_nom').textContent = nom;
    document.getElementById('buton_se_connecter').style.display = 'none';
    document.getElementById('text_place_button_se_connecter').textContent = nom;
    document.getElementById('text_place_button_se_connecter').style.display = 'block';
    open_popup_result();
  } catch (error) {
    document.getElementById('result_message').innerText = 'Erreur lors de la connexion : ' + error.message;
    open_popup_result();
  }
}

async function sendName_create() {
  close_popup_se_connecter();
  close_popup_create_compte();

  const name = document.getElementById('input_id_account').value.trim();
  const firstMp = document.getElementById('input_mp_create_account').value.trim();
  const secondMp = document.getElementById('input_confirm_mp_create_account').value.trim();

  if (!name || !firstMp || !secondMp) {
    document.getElementById('result_message').innerText = 'Veuillez remplir tous les champs.';
    open_popup_result();
    return;
  }

  if (firstMp !== secondMp) {
    document.getElementById('result_message').innerText = 'Les deux mots de passe sont différents';
    open_popup_result();
    return;
  }

  const mp = firstMp;
  const action = 1;

  try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/greet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, mp, action })
    });

    const data = await response.json();

    document.getElementById('result_message').innerText = data.message;
    open_popup_result();
  } catch (error) {
    document.getElementById('result_message').innerText = 'Erreur lors de la création : ' + error.message;
    open_popup_result();
  }
}

const popup = document.getElementById('popup_result');

let isDragging = false;
let offsetY = 0;

popup.addEventListener('mousedown', function (e) {
  isDragging = true;
  offsetY = e.clientY - popup.getBoundingClientRect().top;
  popup.style.cursor = 'grabbing';
});

document.addEventListener('mousemove', function (e) {
  if (!isDragging) return;

  let newY = e.clientY - offsetY;

  // Déplacer le popup
  popup.style.top = newY + 'px';

  // Si on atteint le haut de la page, on le cache
  if (newY <= 0) {
    popup.style.opacity = '0';
    setTimeout(() => popup.style.display = 'none', 300);
    isDragging = false;
  }
});

document.addEventListener('mouseup', function () {
  isDragging = false;
  popup.style.cursor = 'grab';
});
function slideInUp(popup) {
  // Supprime toute animation existante temporairement
  popup.style.animation = 'none';

  const animationName = 'slideInUpJS';

  // Vérifie si l'animation a déjà été injectée
  const alreadyExists = Array.from(document.styleSheets)
    .some(sheet => Array.from(sheet.cssRules || []).some(rule => rule.name === animationName));

  if (!alreadyExists) {
    const styleTag = document.createElement('style');
    styleTag.innerHTML = `
      @keyframes ${animationName} {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(styleTag);
  }

  // Appliquer l’animation
  popup.style.display = 'block';
  popup.style.animation = `${animationName} 0.5s ease-out forwards`;
}


  document.getElementById('overlay').addEventListener('click', closeAllPopups);
</script>
</body>
</html>
