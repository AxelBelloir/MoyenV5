<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connexion Popup</title>
  <link rel="stylesheet" href="main.css" />
</head>
<body>
  
  <div class="Barre_task">
    <button class="buton_se_connecter" id="buton_se_connecter" onclick="open_popup_se_connecter()">Se connecter</button>
    <button class="Home_button" onclick="open_div_Home()">Home</button>
    <button class="buton_Moyen" onclick="open_popup_Moyen()">Moyen</button>
    <button class="buton_question" onclick="open_popup_question()">Question</button>
    <button class="buton_se_connecter" id="text_place_button_se_connecter" onclick="ParametresCompte()" style="display:none;"></button>
    <button class="buton_Admin" id="buton_admin" onclick="open_popup_admin()" style="display:none;">Admin</button>
  </div>

  <div id="overlay"></div>
  <div class="Admin" id="Admin">
    <p id="donneeCompte" class="pdonneCompte"></p>
    <div id="logs" class="logs"></div>
    <button id="supALLcompte" class="supALLcompte" onclick="AdminSupALLCompte()">SUPPRIMER TOUT LES COMPTES</button>
    <button id="supALLnotes" class="supALLnotes" onclick="AdminSupALLnotes()">SUPPRIMER TOUTE LES NOTES</button>
    <button id="SeconnecterAdmin" class="SeconnecterAdmin" onclick="open_popup_se_connecter()">Se connecter Admin</button>
  </div>
  <div class="popup_se_connecter" id="popup_se_connecter" style="display:none;">
    <p class="decors1">__</p>
    <h2 class="h2_connexion">Connexion</h2>
    <p class="Inserez_votre_identifiants">Insérez votre identifiant</p>
    <input type="text" class="input_id" id="input_id" />
    <p class="Inserez_votre_mp">Insérez votre mot de passe</p>
    <input type="password" class="input_mp" id="input_mp" />
    <button class="create_account" type="button" onclick="open_popup_create_compte()">Créer</button>
    <button class="popup_se_connecter_button" onclick="sendName_connexion()">Suivant</button>
  </div>

  <div class="popup_create_compte" id="popup_create_compte" style="display:none;">
    <button class="popup_create_compte_button" onclick="sendName_create()">Créer</button>
    <button class="ruturn_create_account" onclick="open_popup_se_connecter()">Retour</button>
    <h2 class="h2_create_account">Créer un compte</h2>
    <p class="inserez_id_create_account">Insérez un identifiant</p>
    <p class="inserez_mp_create_account">Insérez un mot de passe</p>
    <p class="confirm_mp_create_account">Confirmez le mot de passe</p>
    <input class="input_id_account" id="input_id_account" />
    <input type="password" class="input_mp_create_account" id="input_mp_create_account" />
    <input type="password" class="input_confirm_mp_create_account" id="input_confirm_mp_create_account"/>
    <p class="decors2">__</p>
  </div>

  <div class="Home" id="Home" style="display:block;">
    <h1 id="Welcome" class="Welcome">Welcome <span id="Welcome_nom"></span></h1>
    <div id="Home_div_left"><p></p></div>
  </div>
  <div class="Question" id="Question" style="display:none;"></div>

  <div class="popup_Moyen" id="popup_Moyen" style="display:none;">
    <div class="listPopupMoyen" id="listPopupMoyen">
      <button type="button" onclick="listPopupMoyenHaut()" class="listPopupMoyenba1" id="listPopupMoyenba1">⥣</button>
      <button type="button" onclick="listPopupMoyenBas()" class="listPopupMoyenba2" id="listPopupMoyenba2">⥥</button>
      <select class="SELlistPopupMoyen" id="SELlistPopupMoyen" name="matiere">
        <option value="Mathématiques">Mathématiques</option>
        <option value="Physique">Physique</option>
        <option value="SVT">SVT</option>
        <option value="Français">Français</option>
        <option value="Histoire">Histoire</option>
        <option value="Anglais">Anglais</option>
        <option value="Espagnole">Espagnole</option>
        <option value="Sport">Sport</option>
        <option value="Technologie">Technologie</option>
        <option value="Musique">Musique</option>
        <option value="Arts-plastique">Arts-plastique</option>
        <option value="Latin">Latin</option>
        <option value="Chorale">Chorale</option>
      </select>
      <div class="listPopupMoyen1" id="listPopupMoyen1"><p class="listPopupMoyenp1" id="listPopupMoyenp1">Chargement</p><button type="button" class="listPopupMoyenb1" onclick="supprimerNotesp1()">Delete</button></div>
      <div class="listPopupMoyen2" id="listPopupMoyen2"><p class="listPopupMoyenp2" id="listPopupMoyenp2">Chargement</p><button type="button" class="listPopupMoyenb2" onclick="supprimerNotesp2()">Delete</button></div>
      <div class="listPopupMoyen3" id="listPopupMoyen3"><p class="listPopupMoyenp3" id="listPopupMoyenp3">Chargement</p><button type="button" class="listPopupMoyenb3" onclick="supprimerNotesp3()">Delete</button></div>
      <div class="listPopupMoyen4" id="listPopupMoyen4"><p class="listPopupMoyenp4" id="listPopupMoyenp4">Chargement</p><button type="button" class="listPopupMoyenb4" onclick="supprimerNotesp4()">Delete</button></div>
      <div class="listPopupMoyen5" id="listPopupMoyen5"><p class="listPopupMoyenp5" id="listPopupMoyenp5">Chargement</p><button type="button" class="listPopupMoyenb5" onclick="supprimerNotesp5()">Delete</button></div>
    </div>
    <div class="div_left__popup_Moyen" id="div_left__popup_Moyen">
      <h2 class="h2_div_left__popup_Moyen">Moyen</h2>
      <label class="L1_div_left__popup_Moyen">Moyen General</label>
      <p class="afficher_moyenG" id="afficher_moyen">Aucune Moyen</p>
      <label class="L2_div_left__popup_Moyen">Moyen par matiere</label>
      <select class="SELmatiere_div_left__popup_Moyen" id="matiere_div_left__popup_Moyen" name="matiere">
        <option value="Mathématiques">Mathématiques</option>
        <option value="Physique">Physique</option>
        <option value="SVT">SVT</option>
        <option value="Français">Français</option>
        <option value="Histoire">Histoire</option>
        <option value="Anglais">Anglais</option>
        <option value="Espagnole">Espagnole</option>
        <option value="Sport">Sport</option>
        <option value="Technologie">Technologie</option>
        <option value="Musique">Musique</option>
        <option value="Arts-plastique">Arts-plastique</option>
        <option value="Latin">Latin</option>
        <option value="Chorale">Chorale</option>
      </select>
      <p class="afficher_moyenM" id="afficher_moyen_matiere">Aucune Moyen</p>
    </div>
    <div class="ajouter_notes" id="ajouter_notes">
      <h2 class="h2_div_ajouter_notes">Ajouter une note</h2>
      <label class="Lnote" for="note">Ta note</label>
      <label class="Lsur" for="sur">Sur</label>
      <label class="Lcoef" for="coef">Le coef</label>
      <input id="INnote" class="INnote">
      <input id="INsur" class="INsur">
      <input id="INcoef" class="INcoef">
      <label class="Lmatiere" for="matiere">Choisis une matière :</label>
      <select class="SELmatiere" id="matiere" name="matiere">
        <option value="Mathématiques">Mathématiques</option>
        <option value="Physique">Physique</option>
        <option value="SVT">SVT</option>
        <option value="Français">Français</option>
        <option value="Histoire">Histoire</option>
        <option value="Anglais">Anglais</option>
        <option value="Espagnole">Espagnole</option>
        <option value="Sport">Sport</option>
        <option value="Technologie">Technologie</option>
        <option value="Musique">Musique</option>
        <option value="Arts-plastique">Arts-plastique</option>
        <option value="Latin">Latin</option>
        <option value="Chorale">Chorale</option>
      </select>
      <select class="SELmatiere1" id="SELmatiere1" style="display:none;">
        <option value="EE">EE</option>
        <option value="CE">CE</option>
        <option value="CO">CO</option>
        <option value="EOC">EOC</option>
        <option value="EOI">EOI</option>
      </select> 
      <button class="button_registe_moyenne" onclick="sendnote()">Enregistrer la note</button>
    </div>
  </div>

  <div id="popup_result" class="popup_result" style="display:none;">
    <p id="result_message" class="result_message"></p>
    <button id="bFermeP1" class="bFermeP1" onclick="close_popup_result()">x</button>
  </div>

<script>
  
  let p1ID, p2ID, p3ID, p4ID, p5ID;
  let mp;
  async function chargerNotesInitiales() {
    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 1 })
      });
      const data = await response.json();
      console.log("Notes initiales récupérées :", data);
    } catch (error) {
      console.error("Erreur lors du chargement des notes :", error);
    }
  }
  chargerNotesInitiales();
  async function supprimerNotesp1() {
    const action = 4; 
    const noteID = p1ID;
    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
        action,
        id: window.nom,
        noteID,
      })
    });
      const data = await  response.json();
      document.getElementById("result_message").innerText = "Note supprimer";
      open_popup_result();
      listPopupMoyen();
      loadMoyenneGenerale();
      SendMatiere();
     } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors de la suppresion de la note : ' + error.message;
    open_popup_result();
  }
}
  async function supprimerNotesp2() {
    const action = 4; 
    const noteID = p2ID;
    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
        action,
        id: window.nom,
        noteID,
      })
    });
      const data = await  response.json();
      document.getElementById("result_message").innerText = "Note supprimer";
      open_popup_result();
      listPopupMoyen();
      loadMoyenneGenerale();
      SendMatiere();
     } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors de la suppresion de la note : ' + error.message;
    open_popup_result();
  }
}
  async function supprimerNotesp3() {
    const action = 4; 
    const noteID = p3ID;
    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
        action,
        id: window.nom,
        noteID,
      })
    });
      const data = await  response.json();
      document.getElementById("result_message").innerText = "Note supprimer";
      open_popup_result();
      listPopupMoyen();
      loadMoyenneGenerale();
      SendMatiere();
     } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors de la suppresion de la note : ' + error.message;
    open_popup_result();
  }
}
  async function supprimerNotesp4() {
    const action = 4; 
    const noteID = p4ID;
    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
        action,
        id: window.nom,
        noteID,
      })
    });
      const data = await  response.json();
      document.getElementById("result_message").innerText = "Note supprimer";
      open_popup_result();
      listPopupMoyen();
      loadMoyenneGenerale();
      SendMatiere();
     } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors de la suppresion de la note : ' + error.message;
    open_popup_result();
  }
}
  async function supprimerNotesp5() {
    const action = 4; 
    const noteID = p5ID;
    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
        action,
        id: window.nom,
        noteID,
      })
    });
      const data = await  response.json();
      document.getElementById("result_message").innerText = "Note supprimer";
      open_popup_result();
      listPopupMoyen();
      loadMoyenneGenerale();
      SendMatiere();
     } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors de la suppresion de la note : ' + error.message;
      open_popup_result();
  }
  }
    
  async function chargerLogsAdmin() {
  const action = 3;

  try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/requeteadmin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: action,
        id: window.nom,    // ⚠️ Assure-toi que window.nom est bien défini !
        mp: window.mp      // ⚠️ Assure-toi que window.mp est bien défini !
      })
    });

    const data = await response.json();

    if (data.logs) {
      const logsElement = document.getElementById('logs');
      logsElement.innerText = data.logs
        .map(log => log.join(' - '))
        .join('\n');
    } else {
      throw new Error(data.message || 'Aucune donnée de logs reçue.');
    }

  } catch (error) {
    console.error("Erreur lors du chargement des logs :", error);
    document.getElementById('result_message').innerText =
      'Erreur lors du chargement des logs : ' + error.message;

    // Si tu as une fonction pour ouvrir une popup de résultat
    if (typeof open_popup_result === "function") {
      open_popup_result();
    }
  }
}

  async function AdminRecupALLCompte() {
    const action = 0;
    try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/requeteadmin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
      action,
      id: window.nom,
      mp,
      })
    });

    const data = await  response.json();
    document.getElementById('donneeCompte').innerText = data.message;
    
  } catch (error) {
    console.error("Erreur lors du chargement des comptes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors du chargement des comptes : ' + error.message;
    open_popup_result();
  }
  }
  async function AdminSupALLCompte() {
    const action = 1;
    try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/requeteadmin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
      action,
      id: window.nom,
      mp,
      })
    });

    const data = await  response.json();
    document.getElementById('result_message').innerText = data.message;
    open_popup_result();
  } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors de la suppresion des comptes : ' + error.message;
    open_popup_result();
  }
  }
  async function AdminSupALLnotes() {
    const action = 2;
    try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/requeteadmin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
      action,
      id: window.nom,
      mp,
      })
    });

    const data = await  response.json();
    document.getElementById('result_message').innerText = data.message;
    open_popup_result();
  } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors de la suppresion des notes : ' + error.message;
    open_popup_result();
  }
  }
  function B1Admin() {
    if (window.nom == "Admin") {
      document.getElementById('buton_admin').style.display = 'block';
    }
  }
  function open_popup_question() {
    closeAllPopups();
    close_div_Home();
    document.getElementById('Home').style.display = 'none';
    document.getElementById('Question').style.display = 'block';
  }
  function close_popup_question() {
    document.getElementById('Question').style.display = 'none';
  }
  function open_popup_admin() {
    closeAllPopups();
    close_div_Home();
    AdminRecupALLCompte();
    AdminRecupALLLogs();
    document.getElementById('Home').style.display = 'none';
    document.getElementById('Admin').style.display = 'block';
  }
  function close_popup_admin() {
    document.getElementById('Admin').style.display = 'none';
  }
  function open_popup_Moyen() {
    closeAllPopups();
    loadMoyenneGenerale();
    listPopupMoyen();
    document.getElementById('Home').style.display = 'none';
    document.getElementById('popup_Moyen').style.display = 'block';
  }
  function close_popup_Moyen() {
    document.getElementById('popup_Moyen').style.display = 'none';
  }
  function open_popup_se_connecter() {
    closeAllPopups();
    document.getElementById('Home').style.display = 'block';
    document.getElementById('popup_create_compte').style.display = 'none';
    document.getElementById('popup_se_connecter').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
  }
  function close_popup_se_connecter() {
    document.getElementById('popup_se_connecter').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  }
  function open_popup_result() {
    const popup = document.getElementById('popup_result');
    slideInUp(popup);
    popup.style.display = 'flex';
    popup.style.zIndex = '99999';
    popup.style.position = 'fixed';
    popup.style.bottom = '0%';
    popup.style.right = '0%';
    popup.style.background = 'white';
    popup.style.padding = '30px';
    popup.style.border = '2px solid black';
    popup.style.fontFamily = 'arial';
  }
  function close_popup_result() {
    document.getElementById('popup_result').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  }
  function open_popup_create_compte() {
    closeAllPopups();
    document.getElementById('Home').style.display = 'flex';
    document.getElementById('popup_create_compte').style.display = 'block';
    document.getElementById('popup_se_connecter').style.display = 'none';
    document.getElementById('overlay').style.display = 'block';
  }
  function close_popup_create_compte() {
    document.getElementById('popup_create_compte').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  }
  function open_div_Home() {
    closeAllPopups();
    loadMoyenneGenerale();
    document.getElementById('popup_se_connecter').style.display = 'none';
    document.getElementById('popup_create_compte').style.display = 'none';
    document.getElementById('Home').style.display = 'block';
    document.getElementById('overlay').style.display = 'none';
  }
  function close_div_Home() {
    document.getElementById('Home').style.display = 'none';
  }
  function closeAllPopups() {
    close_popup_se_connecter();
    close_popup_admin();
    close_popup_create_compte();
    close_popup_Moyen();
    close_popup_question();
  }

 async function listPopupMoyen() {
  const selectMatiere = document.getElementById("SELlistPopupMoyen").value;
  const action = 3; 
  try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
      action,
      id: window.nom,
      selectMatiere,
      })
    });

    const data = await  response.json();
    document.getElementById('listPopupMoyenp1').textContent = data.p1;
    document.getElementById('listPopupMoyenp2').textContent = data.p2;
    document.getElementById('listPopupMoyenp3').textContent = data.p3;
    document.getElementById('listPopupMoyenp4').textContent = data.p4;
    document.getElementById('listPopupMoyenp5').textContent = data.p5;
    p1ID = data.p1ID;
    p2ID = data.p2ID;
    p3ID = data.p3ID;
    p4ID = data.p4ID;
    p5ID= data.p5ID;
  } catch (error) {
    console.error("Erreur lors du chargement des moyennes :", error);
    // Optionnel : afficher un message à l'utilisateur
    document.getElementById('result_message').innerText = 'Erreur lors du chargement des moyennes : ' + error.message;
    open_popup_result();
  }
}

  async function loadMoyenneGenerale() {
  const action = 2;

  if (!window.nom || window.nom === "Invité") {
    document.getElementById('afficher_moyen').textContent = 'Non connecté';
    return;
  }

  try {
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action,
        id: window.nom 
      })
    });

    const data = await response.json();

    if (data.moyenne_generale !== undefined) {
      document.getElementById('afficher_moyen').textContent = `${data.moyenne_generale}/20`;
    } else {
      document.getElementById('afficher_moyen').textContent = data.message || 'Erreur';
    }
  } catch (error) {
    document.getElementById('afficher_moyen').textContent = 'Erreur : ' + error.message;
  }
}

  async function sendnote() {
    const matiere = document.getElementById('matiere').value.trim();
    const noteStr = document.getElementById('INnote').value.trim();
    const surStr = document.getElementById('INsur').value.trim();
    const coefStr = document.getElementById('INcoef').value.trim();

    if (!window.nom || window.nom === "Invité") {
      document.getElementById('result_message').innerText = 'Connecte-toi avant d’ajouter une note.';
      open_popup_result();
      return;
    }

    const note = parseFloat(noteStr.replace(',', '.'));
    const sur = parseFloat(surStr.replace(',', '.'));
    const coef = parseFloat(coefStr.replace(',', '.'));
    let autre = "";
if (matiere === "Anglais" || matiere === "Espagnole") {
  autre = document.getElementById('SELmatiere1').value;
}

      

    if (!matiere || isNaN(note) || isNaN(sur) || isNaN(coef)) {
      document.getElementById('result_message').innerText = 'Tous les champs doivent être remplis avec des nombres valides.';
      open_popup_result();
      return;
    }

    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 0,
          id: window.nom,
          matiere,
          note,
          sur,
          coef,
          autre
        })
      });

      const data = await response.json();

      document.getElementById('result_message').innerText = data.message || 'Note enregistrée !';
      open_popup_result();
      SendMatiere();
      loadMoyenneGenerale();
      listPopupMoyen();

      document.getElementById('INnote').value = '';
      document.getElementById('INsur').value = '';
      document.getElementById('INcoef').value = '';
    } catch (error) {
      document.getElementById('result_message').innerText = 'Erreur lors de l\'envoi de la note : ' + error.message;
      open_popup_result();
    }
  }

  async function sendName_connexion() {
    close_popup_se_connecter();
    close_popup_create_compte();

    const name = document.getElementById('input_id').value.trim();
    mp = document.getElementById('input_mp').value.trim();
    const action = 0;

    if (!name || !mp) {
      document.getElementById('result_message').innerText = 'Veuillez remplir tous les champs.';
      open_popup_result();
      return;
    }

    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/greet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, mp, action })
      });

      const data = await response.json();

      document.getElementById('result_message').innerText = data.message;
      const dataValue = data.value;
      if (data.message === "Connexion réussie." || data.message === "Bienvenue admin") {
        Object.defineProperty(window, 'nom', {
          value: data.value,
          writable: false,
          configurable: false
        });

        document.getElementById('Welcome_nom').textContent = window.nom;
        document.getElementById('buton_se_connecter').style.display = 'none';
        document.getElementById('text_place_button_se_connecter').textContent = window.nom;
        document.getElementById('text_place_button_se_connecter').style.display = 'block';
        B1Admin();
      }

      open_popup_result();
    } catch (error) {
      document.getElementById('result_message').innerText = 'Erreur lors de la connexion : ' + error.message;
      open_popup_result();
    }
  }

  async function sendName_create() {
    close_popup_se_connecter();
    close_popup_create_compte();

    const name = document.getElementById('input_id_account').value.trim();
    const firstMp = document.getElementById('input_mp_create_account').value.trim();
    const secondMp = document.getElementById('input_confirm_mp_create_account').value.trim();

    if (!name || !firstMp || !secondMp) {
      document.getElementById('result_message').innerText = 'Veuillez remplir tous les champs.';
      open_popup_result();
      return;
    }

    if (firstMp !== secondMp) {
      document.getElementById('result_message').innerText = 'Les deux mots de passe sont différents';
      open_popup_result();
      return;
    }

    const mp = firstMp;
    const action = 1;
    if (name !== "Admin") {
    try {
      const response = await fetch('https://flask-api-1p4y.onrender.com/api/greet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, mp, action })
      });

      const data = await response.json();
      document.getElementById('result_message').innerText = data.message;
      open_popup_result();
    } catch (error) {
      document.getElementById('result_message').innerText = 'Erreur lors de la création : ' + error.message;
      open_popup_result();
    }} else {
      document.getElementById('result_message').innerText = 'Vous ne pouvez pas vous appeller -> Admin';
      open_popup_result();
    }
  }

  const popup = document.getElementById('popup_result');
  let isDragging = false;
  let offsetY = 0;

  popup.addEventListener('mousedown', function (e) {
    isDragging = true;
    offsetY = e.clientY - popup.getBoundingClientRect().top;
    popup.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', function (e) {
    if (!isDragging) return;
    let newY = e.clientY - offsetY;
    popup.style.top = newY + 'px';
    if (newY <= 0) {
      popup.style.opacity = '0';
      setTimeout(() => popup.style.display = 'none', 300);
      isDragging = false;
    }
  });

  document.addEventListener('mouseup', function () {
    isDragging = false;
    popup.style.cursor = 'grab';
  });

  function slideInUp(popup) {
    popup.style.animation = 'none';
    const animationName = 'slideInUpJS';
    const alreadyExists = Array.from(document.styleSheets)
      .some(sheet => Array.from(sheet.cssRules || []).some(rule => rule.name === animationName));
    if (!alreadyExists) {
      const styleTag = document.createElement('style');
      styleTag.innerHTML = `
        @keyframes ${animationName} {
          from {
            transform: translateY(100%);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
      `;
      document.head.appendChild(styleTag);
    }
    popup.style.display = 'block';
    popup.style.animation = `${animationName} 0.5s ease-out forwards`;
  }

  document.getElementById('overlay').addEventListener('click', closeAllPopups);
  // On récupère l'élément <select> pour la matière (une seule déclaration)
const selectElement = document.getElementById('matiere_div_left__popup_Moyen');
const selectElement1 = document.getElementById('SELlistPopupMoyen');
const SELmatiere = document.getElementById('matiere');

// Fonction qui envoie la matière sélectionnée au serveur et affiche la moyenne par matière
async function SendMatiere() {
  const matiere = selectElement.value; // On récupère la matière sélectionnée
  const action = 1;

  // Si pas connecté, on affiche un message d'erreur
  if (!window.nom || window.nom === "Invité") {
    document.getElementById('result_message').innerText = 'Connecte-toi avant de voir les moyennes.';
    open_popup_result();
    return;
  }

  try {
    // Envoi des données au serveur
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        matiere,
        action,
        id: window.nom
      })
    });

    const data = await response.json();

    // Si on a la moyenne, on l'affiche sinon un message d'erreur
    if (data.moyenne !== undefined) {
      document.getElementById('afficher_moyen_matiere').textContent = `${data.moyenne}/20`;
    } else {
      document.getElementById('afficher_moyen_matiere').textContent = data.message || 'Erreur';
    }
  } catch (error) {
    // En cas d'erreur, affichage du message
    document.getElementById('result_message').innerText = 'Erreur lors de la récupération de la moyenne : ' + error.message;
    open_popup_result();
  }
}
async function AccesDonneeAdmin() {
  if (window.nom == "Admin"){
    try {
    // Envoi des données au serveur
    const action = 0;
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/requeteadmin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        id: window.nom,
        action,
      })
      
    });

    const data = await response.json();

    document.getElementById("donneeCompte").innerText = data.value;
  } catch (error) {
    // En cas d'erreur, affichage du message
    document.getElementById('result_message').innerText = "Erreur system";
    open_popup_result();
  }
  }else{
    try {
    // Envoi des données au serveur
    const date = Date.now();
    const response = await fetch('https://flask-api-1p4y.onrender.com/api/requete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        id: window.nom,
        date
      })
    });

    document.getElementById("result_message").innerText = "Un message a été envoyer aux admin.";
    open_popup_result();
  } catch (error) {
    // En cas d'erreur, affichage du message
    document.getElementById('result_message').innerText = "Erreur system";
    open_popup_result();
  }
  }
}
function EspAngMoyen() {
  const matiere = document.getElementById('matiere').value;
  if (matiere == 'Anglais'){
    document.getElementById('SELmatiere1').style.display = 'block'
  }
  else {
  if (matiere == 'Espagnole') {
    document.getElementById('SELmatiere1').style.display = 'block'
  }
  else {
    document.getElementById('SELmatiere1').style.display = 'none'
  }}
}

// On attache la fonction au changement de sélection (une seule fois)
selectElement.addEventListener('change', SendMatiere);
selectElement1.addEventListener('change', listPopupMoyen);
SELmatiere.addEventListener('change', EspAngMoyen);
</script>
</body>
</html>
